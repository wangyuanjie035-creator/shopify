const SHOP = process.env.SHOPIFY_STORE_DOMAIN || process.env.SHOP;
const ADMIN_TOKEN = process.env.SHOPIFY_ACCESS_TOKEN || process.env.ADMIN_TOKEN;

export async function shopGql(query, variables) {
  const r = await fetch(`https://${SHOP}/admin/api/2024-07/graphql.json`, {
    method: 'POST',
    headers: { 'X-Shopify-Access-Token': ADMIN_TOKEN, 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, variables })
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

export default async function handler(req, res) {
    // CORS - ÊîØÊåÅÂ§ö‰∏™ÂüüÂêç
  const allowedOrigins = [
    'https://sain-pdc-test.myshopify.com',
    'https://rt08kw-se.myshopify.com',
    'http://localhost:3000'
  ];
  
  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
  } else {
    res.setHeader('Access-Control-Allow-Origin', 'https://sain-pdc-test.myshopify.com');
  }
  
  res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PATCH,DELETE,OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type,Accept,Origin');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    return res.status(204).end();
  }
  res.setHeader('Content-Type', 'application/json; charset=utf-8');
  try {
    const m = req.method.toUpperCase();
    if (m === 'GET') {
      const q = `query { metaobjects(type:"quote", first:50){ nodes{ id handle fields{ key value } } } }`;
      const data = await shopGql(q, {});
      
      // ÊöÇÊó∂ËøîÂõûÊâÄÊúâËÆ∞ÂΩïÔºå‰∏çËøáÊª§ÔºàÁî®‰∫éË∞ÉËØïÔºâ
      const allRecords = data.data.metaobjects.nodes;
      
      return res.status(200).json({ records: allRecords, total: allRecords.length });
    }
    if (m === 'POST') {
      const { 
        text='', author='', status='Pending', price='', invoice_url='', email=''
      } = req.body || {};
      
      console.log('POST request data:', { 
        text, author, status, price, invoice_url, email
      });
      
          // Â§ÑÁêÜÊñá‰ª∂URL - ÊîØÊåÅ data: URI
          let fileUrl = String(invoice_url || '');
          
          // Â§ÑÁêÜÊñá‰ª∂URL - Á°Æ‰øùÁ¨¶Âêà Shopify URL Â≠óÊÆµË¶ÅÊ±Ç
          if (!fileUrl || fileUrl === 'data:uri' || fileUrl === 'text:data' || fileUrl === 'data:file') {
            fileUrl = 'data:upload_failed'; // ‰ΩøÁî®Áä∂ÊÄÅÊ†áËØÜÁ¨¶
            console.log('‰ΩøÁî®Áä∂ÊÄÅÊ†áËØÜÁ¨¶Ôºöupload_failed');
          } else if (!fileUrl.startsWith('http://') && !fileUrl.startsWith('https://')) {
            fileUrl = 'data:invalid_url'; // ‰ΩøÁî®Áä∂ÊÄÅÊ†áËØÜÁ¨¶
            console.log('ÈùûÊ†áÂáÜURLÔºå‰ΩøÁî®Áä∂ÊÄÅÊ†áËØÜÁ¨¶Ôºöinvalid_url');
          }
      
      // Â∞Ü email ‰ø°ÊÅØÂêàÂπ∂Âà∞ author Â≠óÊÆµ‰∏≠
      const authorWithEmail = email ? `${author} (${email})` : author;
      
      // ÊûÑÂª∫Âü∫Êú¨Â≠óÊÆµÊï∞ÁªÑÔºàÂè™‰ΩøÁî® Metaobject ‰∏≠Â∑≤ÂÆö‰πâÁöÑÂ≠óÊÆµÔºâ
      const fields = [
        { key:'text', value:String(text) },
        { key:'author', value:String(authorWithEmail) },
        { key:'status', value:String(status) },
        { key:'price', value:String(price) },
        { key:'invoice_url', value:fileUrl }
      ];
      
      // Áî±‰∫é Metaobject Â≠óÊÆµÈôêÂà∂ÔºåÂè™‰ΩøÁî®Âü∫Êú¨Â≠óÊÆµ
      // ÂèÇÊï∞‰ø°ÊÅØÂ∞ÜÂú®ÂâçÁ´ØÂ§ÑÁêÜÊó∂‰ªéË¥≠Áâ©ËΩ¶Ëé∑Âèñ
      
      console.log('‰ΩøÁî®Âü∫Êú¨Â≠óÊÆµÈõÜ:', fields.length, '‰∏™Â≠óÊÆµ');
      console.log('ÂèÇÊï∞‰ø°ÊÅØÂ∞Ü‰ªéË¥≠Áâ©ËΩ¶Ëé∑Âèñ');
      const mql = `mutation($fields:[MetaobjectFieldInput!]!){
        metaobjectCreate(metaobject:{type:"quote", fields:$fields}){
          metaobject{ id handle fields{ key value } } userErrors{ field message }
        }}`;
      const data = await shopGql(mql, { fields });
      const ue = data.data.metaobjectCreate.userErrors;
      if (ue?.length) return res.status(400).json({ errors: ue });
      return res.status(201).json(data.data.metaobjectCreate.metaobject);
    }
    if (m === 'PATCH' || m === 'PUT') {
      const handle = String(req.query.handle || '');
      if (!handle) return res.status(400).json({ error:'Missing handle' });
      
      // üîß ‰øÆÂ§çÔºöÂÖàÈÄöËøá handle Êü•Êâæ idÔºåÊîØÊåÅÈÉ®ÂàÜÂåπÈÖç
      console.log('PATCH request received for handle:', handle);
      
      let lookup = await shopGql(
        `query($handle:String!){ metaobjectByHandle(handle:$handle, type:"quote"){ id } }`,
        { handle }
      );
      
      console.log('Direct lookup result:', JSON.stringify(lookup, null, 2));
      
      let id = lookup.data?.metaobjectByHandle?.id;
      
      // Â¶ÇÊûúÁõ¥Êé•Êü•ÊâæÂ§±Ë¥•ÔºåÂ∞ùËØïÈÉ®ÂàÜÂåπÈÖç
      if (!id) {
        console.log('Direct lookup failed, trying partial match for:', handle);
        
        const allRecords = await shopGql(
          `query { metaobjects(type:"quote", first:100){ nodes{ id handle fields{ key value } } } }`,
          {}
        );
        
        // Êü•ÊâæÂåÖÂê´ handle ÁöÑËÆ∞ÂΩï
        const matchingRecord = allRecords.data?.metaobjects?.nodes?.find(record => 
          record.handle.includes(handle) || handle.includes(record.handle)
        );
        
        if (matchingRecord) {
          id = matchingRecord.id;
          console.log('Found matching record via partial match:', matchingRecord);
        }
      }
      
      if (!id) {
        console.error('Metaobject not found for handle:', handle);
        return res.status(404).json({ error:'Metaobject not found' });
      }
      
      console.log('Found metaobject id:', id);
      
      const fields = Object.entries(req.body || {}).map(([k,v]) => ({ key:k, value:String(v ?? '') }));
      console.log('Fields to update:', fields);
      
      // üîß ‰øÆÂ§çÔºö‰ΩøÁî® id ËÄå‰∏çÊòØ handle
      const mql = `mutation($id:ID!, $fields:[MetaobjectFieldInput!]!){
        metaobjectUpdate(id:$id, metaobject:{fields:$fields}){
          metaobject{ id handle fields{ key value } } userErrors{ field message }
        }}`;
      
      console.log('GraphQL Mutation Query:', mql);
      console.log('GraphQL Mutation Variables:', { id, fields });

      const data = await shopGql(mql, { id, fields });

      console.log('Shopify GraphQL Response (data):', JSON.stringify(data, null, 2));

      // Ê£ÄÊü•È°∂Â±ÇÈîôËØØ
      if (data.errors) {
        console.error('Shopify GraphQL top-level errors:', data.errors);
        return res.status(500).json({ errors: data.errors, message: 'Shopify GraphQL top-level errors' });
      }

      // Ê£ÄÊü• metaobjectUpdate ÊòØÂê¶Â≠òÂú®
      if (!data.data || !data.data.metaobjectUpdate) {
        console.error('Shopify GraphQL response missing data.data.metaobjectUpdate:', data);
        return res.status(500).json({ error: 'Unexpected Shopify GraphQL response structure', response: data });
      }

      const ue = data.data.metaobjectUpdate.userErrors;
      if (ue?.length) {
        console.error('Shopify GraphQL user errors:', ue);
        return res.status(400).json({ errors: ue });
      }
      return res.json(data.data.metaobjectUpdate.metaobject);
    }
    if (m === 'DELETE') {
      const handle = String(req.query.handle || '');
      if (!handle) return res.status(400).json({ error:'Missing handle' });
      
        console.log('DELETE request received for handle:', handle);
        console.log('Looking for exact match first, then partial match');
      
      // ‰ΩøÁî®Ê†áËÆ∞Âà†Èô§ËÄå‰∏çÊòØÁúüÊ≠£Âà†Èô§
      try {
        // ÂÖàÂ∞ùËØïÁõ¥Êé•Êü•Êâæ
        let lookup = await shopGql(
          `query($handle:String!){ metaobjectByHandle(handle:$handle, type:"quote"){ id handle fields{ key value } } }`,
          { handle }
        );
        
        console.log('Direct lookup result:', JSON.stringify(lookup, null, 2));
        
        let id = lookup.data?.metaobjectByHandle?.id;
        
        // Â¶ÇÊûúÁõ¥Êé•Êü•ÊâæÂ§±Ë¥•ÔºåÂ∞ùËØïÈÉ®ÂàÜÂåπÈÖç
        if (!id) {
          console.log('Direct lookup failed, trying partial match for:', handle);
          
          const allRecords = await shopGql(
            `query { metaobjects(type:"quote", first:100){ nodes{ id handle fields{ key value } } } }`,
            {}
          );
          
              console.log('All records:', JSON.stringify(allRecords, null, 2));
              
              // Êü•ÊâæÂåÖÂê´ handle ÁöÑËÆ∞ÂΩï - ‰ºòÂÖàÁ≤æÁ°ÆÂåπÈÖç
              let matchingRecord = allRecords.data?.metaobjects?.nodes?.find(record => 
                record.handle === handle
              );
              
              // Â¶ÇÊûúÊ≤°ÊúâÁ≤æÁ°ÆÂåπÈÖçÔºåÂ∞ùËØïÈÉ®ÂàÜÂåπÈÖç
              if (!matchingRecord) {
                matchingRecord = allRecords.data?.metaobjects?.nodes?.find(record => 
                  record.handle.includes(handle) || handle.includes(record.handle)
                );
              }
              
              if (matchingRecord) {
                id = matchingRecord.id;
                console.log('Found matching record via partial match:', matchingRecord);
                console.log('Matched handle:', matchingRecord.handle, 'with input:', handle);
              } else {
                console.log('No matching record found for handle:', handle);
              }
        }
        
        if (!id) {
          console.log('Metaobject not found for handle:', handle);
          return res.status(404).json({ error:'Metaobject not found' });
        }
        
        console.log('Found metaobject id for deletion:', id);
        
        // Ê†áËÆ∞‰∏∫Â∑≤Âà†Èô§ËÄå‰∏çÊòØÁúüÊ≠£Âà†Èô§
        const updateResult = await shopGql(
          `mutation($id:ID!){ 
            metaobjectUpdate(id:$id, metaobject:{fields:[{key:"status", value:"Deleted"}]}){
              metaobject{ id handle fields{ key value } } 
              userErrors{ field message } 
            } 
          }`,
          { id }
        );
        
        console.log('GraphQL Update Query:', `mutation($id:ID!){ metaobjectUpdate(id:$id, metaobject:{fields:[{key:"status", value:"Deleted"}]}){ metaobject{ id handle fields{ key value } } userErrors{ field message } } }`);
        console.log('GraphQL Update Variables:', { id });
        
        console.log('Mark as deleted result:', JSON.stringify(updateResult, null, 2));
        
        // Ê£ÄÊü•È°∂Â±ÇÈîôËØØ
        if (updateResult.errors) {
          console.error('GraphQL errors:', updateResult.errors);
          return res.status(500).json({ errors: updateResult.errors });
        }
        
        const ue = updateResult.data?.metaobjectUpdate?.userErrors;
        if (ue?.length) {
          console.error('Update user errors:', ue);
          return res.status(400).json({ errors: ue });
        }
        
        // È™åËØÅÊõ¥Êñ∞ÊòØÂê¶ÊàêÂäü
        const updatedMetaobject = updateResult.data?.metaobjectUpdate?.metaobject;
        if (!updatedMetaobject) {
          console.error('Update failed: no metaobject returned');
          return res.status(500).json({ error: 'Update failed' });
        }
        
        console.log('Successfully marked as deleted:', updatedMetaobject.handle);
        
        // Ê∏ÖÁêÜÂÖ≥ËÅîÁöÑÊñá‰ª∂
        try {
          console.log('ÂºÄÂßãÊ∏ÖÁêÜÂÖ≥ËÅîÊñá‰ª∂...');
          const cleanupResponse = await fetch(`${process.env.VERCEL_URL || 'https://shopify-13s4.vercel.app'}/api/cleanup-files`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: handle })
          });
          
          if (cleanupResponse.ok) {
            const cleanupResult = await cleanupResponse.json();
            console.log('Êñá‰ª∂Ê∏ÖÁêÜÁªìÊûú:', cleanupResult);
          } else {
            console.warn('Êñá‰ª∂Ê∏ÖÁêÜÂ§±Ë¥•:', cleanupResponse.status);
          }
        } catch (cleanupError) {
          console.warn('Êñá‰ª∂Ê∏ÖÁêÜÂºÇÂ∏∏:', cleanupError);
        }
        
        // È™åËØÅÊõ¥Êñ∞ÊòØÂê¶ÁúüÊ≠£ÊàêÂäü
        const verifyResult = await shopGql(
          `query($id:ID!){ metaobject(id:$id){ id handle fields{ key value } } }`,
          { id }
        );
        
        console.log('Verification query result:', JSON.stringify(verifyResult, null, 2));
        
        const verifiedStatus = verifyResult.data?.metaobject?.fields?.find(f => f.key === 'status')?.value;
        console.log('Verified status:', verifiedStatus);
        
        if (verifiedStatus !== 'Deleted') {
          console.error('Status update verification failed. Expected: Deleted, Got:', verifiedStatus);
          return res.status(500).json({ 
            error: 'Status update verification failed',
            expected: 'Deleted',
            actual: verifiedStatus
          });
        }
        
        return res.json({ 
          success: true,
          message: 'Metaobject marked as deleted successfully',
          metaobject: updatedMetaobject,
          verified: true
        });
        
      } catch (error) {
        console.error('Delete operation failed:', error);
        return res.status(500).json({ error: error.message });
      }
    }
    return res.status(405).json({ error:'Method Not Allowed' });
  } catch (e) {
    console.error('Server error:', e);
    return res.status(500).json({ error: e?.message || 'Server Error' });
  }
}
